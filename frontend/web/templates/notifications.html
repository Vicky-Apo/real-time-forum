{{define "notifications.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - Forum</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/global.css">
</head>
<body>
    <div class="notifications-container">
        <!-- Back to Home Link -->
        <a href="/" class="back-link">‚Üê Back to Home</a>

        <!-- Header -->
        <div class="notifications-header">
            <h1 class="notifications-title">Your Notifications</h1>
            <div class="notifications-stats">
                {{if .UnreadCount}}
                    <span style="color: #f44336; font-weight: bold;">{{.UnreadCount}} unread</span>
                    {{if gt .TotalCount .UnreadCount}}
                        ‚Ä¢ {{sub .TotalCount .UnreadCount}} read
                    {{end}}
                {{else}}
                    {{if .TotalCount}}
                        All {{.TotalCount}} notifications read
                    {{else}}
                        No notifications
                    {{end}}
                {{end}}
            </div>
        </div>

        <!-- Notifications List -->
        {{if .Notifications}}
            <div class="notifications-list">
                {{range .Notifications}}
                    <div class="notification {{if isUnread .IsRead}}unread{{else}}read{{end}}" data-notification-id="{{.NotificationID}}">
                        <!-- Notification Icon -->
                        <div class="notification-icon">
                            {{if eq .Action "liked"}}
                                üëç
                            {{else if eq .Action "disliked"}}
                                üëé
                            {{else if eq .Action "commented on"}}
                                üí¨
                            {{else}}
                                üîî
                            {{end}}
                        </div>

                        <!-- Notification Content -->
                        <div class="notification-content">
                            <p class="notification-message">
                                <strong>{{.TriggerUsername}}</strong> {{.Action}} <a href="/post/{{.PostID}}">"{{.PostContentPreview}}"</a>
                            </p>
                            <small class="notification-time">{{timeAgo .CreatedAt}}</small>
                        </div>

                        <!-- Actions -->
                        {{if isUnread .IsRead}}
                            <div class="notification-actions">
                                <button class="mark-read-btn" onclick="markAsRead('{{.NotificationID}}', this)">
                                    Mark as Read
                                </button>
                            </div>
                        {{end}}
                    </div>
                {{end}}
            </div>
        {{else}}
            <!-- No Notifications -->
            <div class="no-notifications">
                <div class="no-notifications-icon">üîî</div>
                <h2>No notifications yet</h2>
                <p>When someone likes, dislikes, or comments on your posts, you'll see notifications here.</p>
                <a href="/" style="color: #2196f3; text-decoration: none; font-weight: 500;">Go back to Home</a>
            </div>
        {{end}}
    </div>

    <!-- JavaScript for Mark as Read functionality -->
    <script>
        async function markAsRead(notificationId, button) {
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Marking...';

            try {
                const response = await fetch(`/notifications/mark-read/${notificationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    // Update notification visually
                    const notification = button.closest('.notification');
                    if (notification) {
                        notification.classList.remove('unread');
                        notification.classList.add('read');
                        
                        // Remove the mark as read button
                        const actionsDiv = button.closest('.notification-actions');
                        if (actionsDiv) {
                            actionsDiv.remove();
                        }
                    }

                    // Update notification stats
                    updateNotificationStats();
                } else {
                    throw new Error('Failed to mark as read');
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
                alert('Failed to mark notification as read. Please try again.');
                
                // Restore button state
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        function updateNotificationStats() {
            // Count remaining unread notifications
            const unreadNotifications = document.querySelectorAll('.notification.unread').length;
            const totalNotifications = document.querySelectorAll('.notification').length;
            
            // Update stats display
            const statsDiv = document.querySelector('.notifications-stats');
            if (statsDiv) {
                if (unreadNotifications > 0) {
                    const readCount = totalNotifications - unreadNotifications;
                    statsDiv.innerHTML = `<span style="color: #f44336; font-weight: bold;">${unreadNotifications} unread</span>` +
                        (readCount > 0 ? ` ‚Ä¢ ${readCount} read` : '');
                } else {
                    if (totalNotifications > 0) {
                        statsDiv.innerHTML = `All ${totalNotifications} notifications read`;
                    } else {
                        statsDiv.innerHTML = 'No notifications';
                    }
                }
            }
        }
    </script>
</body>
</html>
{{end}}